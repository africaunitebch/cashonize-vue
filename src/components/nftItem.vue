<script setup lang="ts">
  import { ref, onMounted, watch, toRefs, computed } from 'vue';
  import { Wallet, TestNetWallet, TokenSendRequest, BCMR } from "mainnet-js"
  import { type UtxoI } from "mainnet-js"
  // @ts-ignore
  import { createIcon } from '@download/blockies';
  import type { IdentitySnapshot } from "mainnet-js"

  const props = defineProps<{
    wallet: Wallet | TestNetWallet | null,
    nftData: UtxoI,
    tokenMetaData: IdentitySnapshot | null,
    chaingraph: string
    ipfsGateway: string
    explorerUrl: string
    id: string
  }>()
  const { wallet, nftData, tokenMetaData, ipfsGateway, explorerUrl, id } = toRefs(props);

  const displaySendNft = ref(false);
  const displayNftInfo = ref(false);
  const displayMintNfts = ref(false);
  const displayBurnNft = ref(false);
  const destinationAddr = ref("");

  const nftMetadata = computed(() => {
    const commitment = nftData.value?.token?.commitment;
    return tokenMetaData?.value?.token?.nfts?.parse?.types[commitment ?? ""];
  })
  const httpsUrlTokenIcon = computed(() => {
    let tokenIconUri = tokenMetaData.value?.uris?.icon;
    const nftIconUri = nftMetadata.value?.uris?.icon;
    if(nftIconUri) tokenIconUri = nftIconUri;
    if(tokenIconUri?.startsWith('ipfs://')){
      return ipfsGateway.value + tokenIconUri.slice(7);
    }
    return tokenIconUri;
  })
  const tokenName = computed(() => {
    let tokenName = tokenMetaData.value?.name;
    const nftName = nftMetadata.value?.name;
    if(nftName) tokenName = nftName;
    return tokenName;
  })
  const nftDescription = computed(() => {
    let tokenDescription = tokenMetaData.value?.description;
    const nftDescription = nftMetadata.value?.description;
    if(tokenDescription) tokenDescription = nftDescription;
    return tokenDescription;
  })

  onMounted(() => {
    const tokenId = nftData.value.token?.tokenId as string;
    let icon = createIcon({
      seed: tokenId,
      size: 12,
      scale: 4,
      spotcolor: '#000'
    });
    icon.style = "display: block; border-radius: 50%;"
    const template = document.querySelector(`#${id.value}`);
    const iconDiv = template?.querySelector("#genericTokenIcon")
    iconDiv?.appendChild(icon);
    tokenMetaData.value = BCMR.getTokenInfo(tokenId) ?? null;
  })

  async function sendNft(wallet: TestNetWallet | null){
    try{
      if(!wallet || nftData.value?.token) return;
      const nftInfo = nftData.value.token;
      const tokenId = nftInfo?.tokenId as string;
      const tokenCommitment = nftInfo?.commitment;
      const tokenCapability = nftInfo?.capability;
      const { txId } = await wallet.send([
        new TokenSendRequest({
          cashaddr: destinationAddr.value,
          tokenId: tokenId,
          commitment: tokenCommitment,
          capability: tokenCapability,
        }),
      ]);
      console.log(tokenCommitment, tokenCapability)
      const displayId = `${tokenId.slice(0, 20)}...${tokenId.slice(-10)}`;
      alert(`Sent NFT of category ${displayId} to ${destinationAddr.value}`);
      console.log(`Sent NFT of category ${displayId} to ${destinationAddr.value} \n${explorerUrl.value}/tx/${txId}`);
      destinationAddr.value = "";
      displaySendNft.value = false;
    } catch(error){
      console.log(error)
    }
  }
  async function burnNft(wallet: TestNetWallet | null) {
    const nftInfo = nftData.value.token;
      const tokenId = nftInfo?.tokenId as string;
    let burnWarning = "You ae about to burn a minting NFT, this can not be unddone. \nAre you sure you want to burn the NFT?";
    if (confirm(burnWarning) != true) return;
    if(!wallet) return;
    try {
      const { txId } = await wallet.tokenBurn(
        {
          tokenId: tokenId,
          capability: "minting",
          commitment: nftInfo?.commitment,
        },
        "burn", // optional OP_RETURN message
      );
      const displayId = `${tokenId.slice(0, 20)}...${tokenId.slice(-10)}`;
      alert(`Burned minting NFT of category ${displayId}`);
      console.log(`Burned minting NFT of category ${displayId} \n${explorerUrl.value}/tx/${txId}`);
    } catch (error) { alert(error) }
  }
</script>

<template id="nft-template">
  <div class="item" :id="id">
    <fieldset style="position: relative;">
      <legend>
        <div id="tokenType"></div>
      </legend>
      <!--<div v-if="tokenData?.verified" id="verified" class="verified">
        <div class="tooltip">
          <img class="verifiedIcon" src="/images/check-circle.svg">
          <span class="tooltiptext">Verified</span>
        </div>
      </div>-->
      <div class="tokenInfo">
        <div v-if="!tokenMetaData?.uris?.icon" id="genericTokenIcon" class="tokenIcon"></div>
        <img v-if="tokenMetaData?.uris?.icon" id="tokenIcon" class="tokenIcon" style="width: 48px; border-radius: 50%;" :src="httpsUrlTokenIcon">
        <!--<div v-if="tokenData?.nft" id="tokenIconModal" class="modal">
          <span class="close">&times;</span>
          <img class="modal-content" id="imgTokenIcon" style="width: 400px; max-width: 80%;">
          <div id="caption"></div>
        </div>-->
        <div class="tokenBaseInfo">
          <div class="tokenBaseInfo1">
            <div v-if="tokenName" id="tokenName">Name: {{ tokenName }}</div>
            <div style="word-break: break-all;"> Commitment: {{ nftData?.token?.commitment ? nftData?.token?.commitment : "none"  }}</div>
          </div>
        </div>
      </div>

      <div class="actionBar">
        <span @click="displaySendNft = !displaySendNft" style="margin-left: 10px;">
          <img id="sendIcon" class="icon" src="/images/send.svg"> send </span>
        <span v-if="nftMetadata" @click="displayNftInfo = !displayNftInfo" id="infoButton">
          <img id="infoIcon" class="icon" src="/images/info.svg"> info
        </span>
        <span @click="displayMintNfts = !displayMintNfts" v-if="nftData?.token?.capability == 'minting'">
          <img id="mintIcon" class="icon" src="/images/hammer.svg"> mint NFTs
        </span>
        <span @click="displayBurnNft = !displayBurnNft" v-if="nftData?.token?.capability == 'minting'" style="white-space: nowrap;">
          <img id="burnIcon" class="icon" src="/images/fire.svg">
          <span class="hidemobile">burn NFT</span>
        </span>
        <!--<span v-if="tokenData?.auth" style="white-space: nowrap;" id="authButton">
          <img id="authIcon" class="icon" src="/images/shield.svg">
          <span class="hidemobile">auth transfer</span>
          <span class="showmobile">auth</span>
        </span>-->
        <div v-if="displayNftInfo" id="tokenInfoDisplay" style="margin-top: 10px;">
          <div id="tokenBegin"></div>
          <div v-if="tokenMetaData?.description" id="tokenDescription"> {{ nftDescription }} </div>
          <div id="tokenCommitment"></div>
          <div id="tokenWebLink"></div>
          <div id="onchainTokenInfo" style="white-space: pre-line;"></div>
          <details v-if="nftMetadata?.extensions?.attributes" style="cursor:pointer;">
            <summary>NFT attributes</summary>
            <div v-for="(attributeValue, attributeKey) in nftMetadata?.extensions?.attributes" :key="((attributeValue as string) + (attributeValue as string))" style="white-space: pre-wrap;">
              {{ attributeKey }}: {{ attributeValue }}
            </div>
          </details>
        </div>
        <div v-if="displaySendNft" id="nftSend" style="margin-top: 10px;">
          Send this NFT to
          <p class="grouped">
            <input v-model="destinationAddr" id="tokenAddress" placeholder="token address">
            <input @click="sendNft(wallet)" type="button" class="primaryButton" id="sendNFT" value="Send NFT">
          </p>
        </div>
        <div id="nftMint" v-if="displayMintNfts" style="margin-top: 10px;">
          Mint a number of (unique) NFTs to a specific address
          <div>
            <input type="checkbox" checked id="uniqueNFTs" onchange="disableInputfield(event)" style="margin: 0px; vertical-align: text-bottom;">
            make each NFT unique by numbering each one in the collection
          </div>
          <p class="grouped" style="align-items: center; margin-bottom: 5px;">
            <input id="amountNFTs" type="number" placeholder="amount NFTs">
            <input id="startingNumberNFTs" type="number" placeholder="starting number" style="margin-right: 0px;">
            <input id="commitmentNFTs" placeholder="commitment" style="display: none;">
          </p>
          <span class="grouped">
            <input id="destinationAddr" placeholder="destinationAddress"> 
            <input type="button" id="mintNFTs" value="Mint NFTs">
          </span>
        </div>
        <div v-if="displayBurnNft" id="nftBurn" style="margin-top: 10px;">
          Burn this NFT so no new NFTs of this category can be minted
          <br>
          <input @click="burnNft(wallet)" type="button" id="burnNFT" value="burn NFT" class="button error">
        </div>
        <!---<div id="authTransfer" class="hide" style="margin-top: 10px;">
          Transfer the authority to change the token's metadata to another wallet <br>
          This should be to a wallet with coin-control, where you can label the Auth UTXO<br>
          It is recommended to use the Electron Cash pc wallet<br>
          <br>
          <span class="grouped">
            <input id="destinationAddr" placeholder="destinationAddress"> 
            <input type="button" id="transferAuth" value="Transfer Auth">
          </span>
        </div>-->
      </div>
    </fieldset>
  </div>
</template>